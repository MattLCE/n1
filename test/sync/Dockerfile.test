FROM golang:1.23-alpine

WORKDIR /app

# Install required tools
RUN apk add --no-cache curl jq bash

# Copy go.mod and go.sum
COPY go.mod go.sum ./
RUN go mod download

# Copy the source code
COPY . .

# Build the test runner
RUN CGO_ENABLED=1 GOOS=linux go test -c -o /app/bin/sync.test ./test/sync

# Create test directory
WORKDIR /test

# Default command
CMD ["sh", "-c", "/app/bin/sync.test -test.v"]